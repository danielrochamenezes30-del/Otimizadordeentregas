<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Entregas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%233b82f6'%3E%3Cpath fill-rule='evenodd' d='M5.478 5.558A1.5 1.5 0 0 1 6.912 4.5H9A.75.75 0 0 1 9.75 5.25v2.53A1.496 1.496 0 0 1 8.25 9H6.912a1.5 1.5 0 0 1-1.434-.942l-2.43-6a.75.75 0 0 1 .942-1.026l1.488.638ZM12.75 5.25A.75.75 0 0 0 12 6v13.5a.75.75 0 0 0 .75.75h4.5a.75.75 0 0 0 .75-.75V6a.75.75 0 0 0-.75-.75h-4.5Z' clip-rule='evenodd' /%3E%3Cpath d='m4.512 11.558 2.43 6A1.5 1.5 0 0 0 8.376 19.5H9a.75.75 0 0 0 .75-.75v-2.53a1.496 1.496 0 0 0-1.5-1.47H6.876a1.5 1.5 0 0 0-1.434.942l-2.43 6a.75.75 0 0 0 .942 1.026l1.488-.638ZM21.75 6.75A.75.75 0 0 0 21 6H19.5a.75.75 0 0 0-.75.75v13.5a.75.75 0 0 0 1.5 0V7.5H21a.75.75 0 0 0 .75-.75Z' /%3E%3C/svg%3E">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
            color: #1e293b; /* Slate 800 */
            overflow-x: hidden;
        }
        .form-input, .cep-input, .address-search-input {
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem; border: 1px solid #cbd5e1; /* Slate 300 */
            background-color: #f8fafc; /* Slate 50 */
            color: #1e293b; /* Slate 800 */
            padding: 0.75rem;
        }
        .form-input::placeholder, .cep-input::placeholder, .address-search-input::placeholder { color: #94a3b8; /* Slate 400 */ }
        .form-input:focus, .cep-input:focus, .address-search-input:focus {
             outline: none; border-color: #3b82f6; /* Blue 500 */
             box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); /* Ring Blue 500 */
             background-color: #fff;
        }
        label { color: #475569; /* Slate 600 */}
        .radio-label { color: #334155; /* Slate 700 */}
        input[type="radio"] {
             color: #3b82f6; /* blue-500 */
             border-color: #94a3b8; /* slate-400 */
        }
        input[type="radio"]:focus { ring: #3b82f6; ring-offset-color: #f1f5f9;}
        input[type="radio"]:checked { background-color: #3b82f6; border-color: #3b82f6;}

        /* Estilos dos cards e botões */
        .card {
             background-color: #ffffff; /* White */
             border-radius: 0.75rem;
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Shadow lg */
             border: 1px solid #e2e8f0; /* Slate 200 */
        }
        .btn {
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem; padding: 0.6rem 1.2rem;
            font-weight: 600; text-align: center; display: inline-flex;
            align-items: center; justify-content: center; gap: 0.5rem;
            cursor: pointer;
        }
         .btn:disabled {
             opacity: 0.5;
             cursor: not-allowed;
         }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #2563eb; }
        .btn-secondary { background-color: #64748b; color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #475569; }
         .btn-success { background-color: #10b981; color: white; }
         .btn-success:hover:not(:disabled) { background-color: #059669; }

         .btn-info { background-color: #0ea5e9; color: white; }
         .btn-info:hover:not(:disabled) { background-color: #0284c7; }

        .btn-danger { background-color: #ef4444; color: white; padding: 0.3rem 0.6rem; font-size: 0.8rem; border: 1px solid #dc2626;}
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .btn-lookup {
             padding: 0.4rem 0.8rem;
             font-size: 0.875rem; /* text-sm */
             background-color: #10b981;
             color: white;
             /* Correção Botão Gigante: Adiciona altura mínima */
             min-height: calc(1.25rem + 0.8rem + 2px); /* Aproxima altura (ícone h-4 + padding y + borda) */
             box-sizing: border-box; /* Garante que padding/borda não aumentem o tamanho total */
        }
        .btn-lookup:hover:not(:disabled) { background-color: #059669; }

        /* Botão de status */
        .btn-toggle-status {
             padding: 0.3rem 0.6rem; font-size: 0.8rem; min-width: 140px;
             background-color: #f8fafc; color: #475569; border: 1px solid #cbd5e1;
        }
        .btn-toggle-status:hover:not(:disabled) { background-color: #e2e8f0; }
        .btn-toggle-status.pending { background-color: #ccfbf1; color: #0f766e; border-color: #5eead4; }
        .btn-toggle-status.pending:hover:not(:disabled) { background-color: #99f6e4; }
        .btn-toggle-status.delivered { background-color: #e5e7eb; color: #4b5563; border-color: #d1d5db; }
        .btn-toggle-status.delivered:hover:not(:disabled) { background-color: #d1d5db; }
        .btn-toggle-status.not_home { background-color: #ffedd5; color: #9a3412; border-color: #fdba74; }
        .btn-toggle-status.not_home:hover:not(:disabled) { background-color: #fed7aa; }


        /* Estilo da Rota Otimizada e Lista de Gerenciamento (compartilhado) */
        .route-list, .management-list { list-style-type: none; margin-left: 0; padding-left: 0; }
        .route-list { list-style-type: decimal; margin-left: 1.5rem; }

        .route-list-item, .management-list-item {
             background-color: #ffffff;
             padding: 0.75rem 1rem;
             border-radius: 0.75rem;
             margin-bottom: 1rem;
             border: 1px solid #e2e8f0;
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
             position: relative;
        }
         .route-list-item p, .management-list-item p { margin: 0.1rem 0; font-size: 0.95rem; color: #334155; }
         .route-list-item strong, .management-list-item strong { color: #1e293b; font-size: 1.05rem; }

        /* Estilos para itens com status */
        .delivered-item { opacity: 0.6; background-color: #f8fafc; }
        .delivered-item strong { text-decoration: line-through; color: #475569; }
        .not-home-item { background-color: #fffbeb; border-left: 4px solid #f59e0b; }

        /* Cor da distância (km) */
        .route-distance { font-size: 0.8rem; color: #64748b; font-weight: 500; display: block; }

        /* Estilo da lista de entregas (Fallback - Básico) */
        .bairro-group h3 {
             color: #1e3a8a; border-bottom: 2px solid #dbeafe;
             margin-top: 1.5rem; margin-bottom: 1rem; padding-bottom: 0.5rem;
             font-size: 1.25rem; font-weight: 600;
        }
        .street-group h4 {
              font-weight: 500; color: #374151;
              margin-top: 0.75rem; margin-bottom: 0.5rem; padding-left: 0.5rem;
              font-size: 1rem; border-left: 3px solid #60a5fa;
        }
        .delivery-item { display: flex; justify-content: space-between; align-items: center; }

        .size-tag {
             padding: 0.1rem 0.5rem; border-radius: 0.25rem;
             font-size: 0.75rem; font-weight: 500; margin-left: 0.5rem;
        }
        .size-grande { background-color: #fecaca; color: #991b1b; }
        .size-pequeno { background-color: #d1fae5; color: #065f46; }

        /* Estilos para Resultados da Busca de CEP */
        #cep-results {
             margin-top: 1rem; padding: 0.75rem; background-color: #f8fafc;
             border: 1px solid #e2e8f0; border-radius: 0.5rem;
             min-height: 50px; max-height: 200px; overflow-y: auto;
        }
        #cep-results p { margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px dashed #cbd5e1; font-size: 0.875rem; }
        #cep-results p:last-child { border-bottom: none; margin-bottom: 0; }
         #cep-results strong { color: #1e3a8a; }

        /* Estilo da tela de Carregando/Login */
        #login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background-color: #f1f5f9; }
        /* Botão Login Google */
        #google-login-button {
             background-color: #4285F4; color: white; padding: 0.75rem 1.5rem;
             border-radius: 0.5rem; font-weight: 600; display: inline-flex;
             align-items: center; gap: 0.75rem; transition: background-color 0.2s;
             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #google-login-button:hover { background-color: #357ae8; }
        #google-login-button svg { width: 1.25rem; height: 1.25rem; }


        /* Botões de Navegação */
        .nav-button {
             background-color: transparent; border: none; color: #dbeafe;
             font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.375rem;
             transition: all 0.2s;
        }
        .nav-button:hover { background-color: rgba(255, 255, 255, 0.1); color: white; }
        .nav-button.active { background-color: #ffffff; color: #2563eb; }

        /* Barra de Verificação de Email */
        #email-verification-bar {
             background-color: #fef9c3; color: #713f12; padding: 0.75rem 1rem;
             border-bottom: 1px solid #fde68a; text-align: center; font-size: 0.875rem;
        }
        #email-verification-bar button {
             margin-left: 0.5rem; padding: 0.2rem 0.6rem; font-size: 0.75rem;
             background-color: #fbbf24; color: #78350f; border-radius: 0.375rem;
             transition: background-color 0.2s;
        }
         #email-verification-bar button:hover { background-color: #f59e0b; }
         #email-verification-bar button:disabled { opacity: 0.6; cursor: not-allowed; }


        /* Override Print Styles */
        @media print { /* ... estilos de impressão iguais ... */ }
    </style>
</head>
<body class="antialiased">

    <div id="login-container"> <div class="card p-8 text-center max-w-sm mx-auto">
             <div class="flex justify-center items-center gap-4 mb-4">
                 <svg id="loading-spinner" class="h-10 w-10 text-blue-500 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"> /* ... */ </svg>
                 <svg id="static-icon" class="h-10 w-10 text-blue-500" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"> /* ... */ </svg>
                 <h1 class="text-3xl font-title text-slate-800">Organizador de Entregas</h1>
             </div>
             <p id="login-message" class="text-slate-600 mb-6">Verificando autenticação...</p>
             <button id="google-login-button" onclick="loginWithGoogle()" style="display: none;">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24px" height="24px"> /* ... */ </svg>
                 Entrar com Google
             </button>
              <p id="auth-error" class="text-red-500 text-sm mt-4" style="display: none;"></p>
        </div>
    </div>

    <div id="app-container" style="display: none;">
        <header class="bg-gradient-to-r from-blue-600 to-blue-500 shadow-lg pb-4 pt-12 border-b border-blue-700 relative">
            <div class="container mx-auto px-6 text-center">
                 <div class="flex justify-center items-center gap-4 mb-4">
                     <svg class="h-10 w-10 text-white drop-shadow-lg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"> /* ... */ </svg>
                     <h1 class="text-3xl md:text-4xl font-title text-white drop-shadow-md">Organizador de Entregas</h1>
                 </div>
                 <div id="nav-buttons" class="mt-6 flex justify-center gap-2">
                     <button id="nav-route" onclick="showView('route-view')" class="nav-button active">Ver Rota Atual</button>
                     <button id="nav-management" onclick="showView('management-view')" class="nav-button">Gerenciar Entregas</button>
                 </div>
            </div>
            <div id="user-info" class="absolute top-4 right-6 text-white text-right">
                 <p id="user-display-name" class="text-sm font-medium truncate max-w-[200px]" title="Usuário logado"></p>
                 <button onclick="logout()" class="text-xs font-semibold text-blue-200 hover:text-white hover:underline transition-colors">
                     Sair
                 </button>
            </div>
        </header>

        <div id="email-verification-bar" style="display: none;"> /* ... */ </div>

        <main class="container mx-auto px-6 py-8">
            <div class="max-w-2xl mx-auto">
                <div id="route-view">
                    <section id="start-address-section" class="card p-6 mb-8"> /* ... Campos Base ... */ </section>
                    <section id="add-delivery-form" class="card p-6 mb-8"> /* ... Campos Nova Entrega ... */ </section>
                    <section id="cep-search-form" class="card p-6 mb-8"> /* ... Busca CEP por Endereço ... */ </section>
                    <section id="delivery-list-section" class="card p-6"> /* ... Lista Rota ... */ </section>
                </div>
                <div id="management-view" style="display: none;">
                     <section class="card p-6"> /* ... Lista Gerenciamento ... */ </section>
                 </div>
            </div>
        </main>
    </div> <script type="module">
        // Importações (usando Redirect)
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth, onAuthStateChanged, signInWithRedirect, getRedirectResult,
            GoogleAuthProvider, signOut, sendEmailVerification
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore, collection, addDoc, onSnapshot, query, deleteDoc,
            doc, Timestamp, setDoc, getDoc, updateDoc, orderBy
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis Globais
        let app, db, auth;
        let userId = null;
        let deliveriesUnsubscribe = null;
        let currentDeliveries = [];
        let lastOptimizedRoute = [];
        let currentView = 'route-view';
        let authReady = false; // Flag crucial para fluxo de redirect
        let baseAddress = { street: '', number: '', neighborhood: '', city: '', uf: '' };

        // Elementos DOM
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const userDisplayElement = document.getElementById('user-display-name');
        const authErrorElement = document.getElementById('auth-error');
        const loginMessageElement = document.getElementById('login-message');
        const loginButton = document.getElementById('google-login-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const staticIcon = document.getElementById('static-icon');
        const emailVerificationBar = document.getElementById('email-verification-bar');
        const resendVerificationButton = document.getElementById('resend-verification-button');
        const resendStatusElement = document.getElementById('resend-status');

        // Config Firebase
        const firebaseConfig = { /* ... sua config ... */ };
        let firebaseInitialized = false;

        // --- Funções Auxiliares ---
        function updateLoginUI(isLoading, message, isError = false) { /* ... código igual ... */ }
        function assembleAddressString(addrObj) { /* ... código igual ... */ }
        function getFirestoreCollection(collectionName) { /* ... código igual ... */ }
        function getFirestoreDoc(collectionName, docId) { /* ... código igual ... */ }
        function getSettingsDocRef() { /* ... código igual ... */ }

        // --- Inicialização e Autenticação ---
        document.addEventListener('DOMContentLoaded', () => {
             console.log("DOM Carregado. Inicializando Firebase...");
             updateLoginUI(true, "Inicializando...");
             try {
                 app = initializeApp(firebaseConfig);
                 db = getFirestore(app);
                 auth = getAuth(app);
                 firebaseInitialized = true;
                 console.log("Firebase inicializado OK.");

                 // Fluxo de Autenticação com Redirect
                 console.log("Verificando resultado do Redirect...");
                 updateLoginUI(true, "Verificando autenticação...");

                 getRedirectResult(auth)
                     .then(async (result) => {
                         console.log("getRedirectResult concluído.");
                         if (result && result.user) {
                             console.log("Redirect Result OBTEVE usuário:", result.user.uid);
                             // O usuário acabou de logar via redirect
                         } else {
                             console.log("Nenhum usuário obtido do Redirect Result (pode ser a primeira visita, refresh ou logout).");
                         }
                         // Importante: Marcar authReady como true AQUI, antes de configurar o listener principal
                         authReady = true;
                         setupAuthStateListener(); // Configura o listener DEPOIS de verificar o redirect
                     })
                     .catch((error) => {
                         console.error("Erro CRÍTICO ao verificar Redirect Result:", error.code, error.message);
                         authReady = true; // Marca como pronto mesmo com erro crítico inicial
                         updateLoginUI(false, `Erro na verificação inicial: ${error.message}`, true);
                         setupAuthStateListener(); // Tenta configurar o listener mesmo assim
                     });

             } catch (initError) {
                  console.error("Erro CRÍTICO ao inicializar Firebase:", initError);
                  updateLoginUI(false, `Erro Crítico: ${initError.message}. Verifique a config.`, true);
                  firebaseInitialized = false;
                  authReady = true; // Permite que o estado de "deslogado" seja exibido
             }
        });

        // Configura o listener principal
        function setupAuthStateListener() {
            console.log("Configurando onAuthStateChanged listener...");
            onAuthStateChanged(auth, async (user) => {
                console.log("onAuthStateChanged disparado. Usuário:", user ? user.uid : 'null', "AuthReady:", authReady);

                // Espera getRedirectResult terminar (authReady === true)
                if (!authReady) {
                    console.log("Auth ainda não está pronta (getRedirectResult pendente), aguardando...");
                    updateLoginUI(true, "Verificando autenticação..."); // Mantém o loading
                    return; // Sai e espera a próxima chamada quando authReady for true
                }

                if (user) {
                    // Usuário LOGADO (seja por redirect ou sessão existente)
                    userId = user.uid;
                    console.log("Estado: LOGADO.", user.displayName, userId);
                    if (userDisplayElement) { /* ... atualiza nome ... */ }
                    if (!user.emailVerified) { /* ... lógica de verificação de email ... */ }
                    else { if (emailVerificationBar) emailVerificationBar.style.display = 'none'; }

                    if (appContainer) appContainer.style.display = 'block';
                    if (loginContainer) loginContainer.style.display = 'none';
                    showView(currentView);
                    await loadSettings();
                    loadDeliveries(); // Começa a ouvir as entregas
                } else {
                    // Usuário DESLOGADO
                    console.log("Estado: DESLOGADO.");
                    userId = null;
                    if (deliveriesUnsubscribe) { // Para o listener de entregas
                        console.log("Cancelando listener de entregas.");
                        deliveriesUnsubscribe();
                        deliveriesUnsubscribe = null;
                    }
                    currentDeliveries = []; // Limpa dados locais
                    lastOptimizedRoute = [];
                    baseAddress = { street: '', number: '', neighborhood: '', city: '', uf: '' };

                    // Limpa todos os campos de formulário
                    ['start-street', 'start-number', 'start-neighborhood', 'start-city', 'start-uf', 'start-cep',
                     'delivery-street', 'delivery-number', 'delivery-neighborhood', 'delivery-city', 'delivery-uf', 'delivery-cep']
                     .forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.value = '';
                     });
                     const sizePequenoRadio = document.querySelector('input[name="size"][value="Pequeno"]');
                     if (sizePequenoRadio) sizePequenoRadio.checked = true;
                     // Limpa listas na UI
                     const routeListEl = document.getElementById('delivery-list');
                     if (routeListEl) routeListEl.innerHTML = '<p class="text-slate-500 text-center">Faça login para ver suas entregas.</p>';
                     const mgmtListEl = document.getElementById('management-delivery-list');
                     if (mgmtListEl) mgmtListEl.innerHTML = '<p class="text-slate-500 text-center">Faça login para ver suas entregas.</p>';


                    if (emailVerificationBar) emailVerificationBar.style.display = 'none';
                    if (appContainer) appContainer.style.display = 'none';
                    if (loginContainer) loginContainer.style.display = 'flex';
                    if (firebaseInitialized) {
                        updateLoginUI(false, "Faça login para salvar e gerenciar suas rotas.");
                    } else {
                        // Se firebase falhou na inicialização, authReady será true mas firebaseInitialized será false
                        updateLoginUI(false, "Erro na inicialização. Recarregue a página.", true);
                    }
                }
            });
        }


        // --- Funções de Ação ---

        // Login com Google (Redirect)
        window.loginWithGoogle = async () => { /* ... código igual ... */ };

        // Logout com Logs
        window.logout = async () => {
            console.log("Logout function called."); // Log 1
            if (!auth || !firebaseInitialized) {
                console.warn("Logout attempt aborted: Auth or Firebase not ready.");
                return;
            }
            try {
                console.log("Attempting signOut..."); // Log 2
                await signOut(auth);
                console.log("signOut successful. onAuthStateChanged should trigger cleanup."); // Log 3
                // A limpeza agora é feita pelo onAuthStateChanged quando detecta user === null
            } catch (error) {
                console.error("Erro CRÍTICO ao sair:", error); // Log 4
                // Informar o usuário sobre o erro pode ser útil aqui
                 if (authErrorElement) { // Reutiliza o elemento de erro do login
                     authErrorElement.textContent = `Erro ao sair: ${error.message}`;
                     authErrorElement.style.display = 'block';
                 }
            }
        };

        // Reenviar Email de Verificação
        window.resendVerificationEmail = async () => { /* ... código igual ... */ };

        // Controle de Visualização
        window.showView = (viewId) => { /* ... código igual ... */ };

        // Salvar Configurações (Endereço Base)
        async function saveSettings(settingsData) { /* ... código igual ... */ }

        // Carregar Configurações (Endereço Base)
        async function loadSettings() { /* ... código igual ... */ }

        // Adicionar Entrega (com verificação reforçada)
        window.addDelivery = function() {
              const collRef = getFirestoreCollection('deliveries');
              const cepErrorEl = document.getElementById('delivery-cep-error');

               // **CORREÇÃO REFORÇADA: Verifica auth, userId e db**
               if (!authReady || !auth.currentUser || !userId || !db) {
                   console.warn("Tentativa de adicionar entrega antes da autenticação/DB estar pronto.");
                   if(cepErrorEl){
                       cepErrorEl.textContent="Aguardando conexão/autenticação... Tente novamente em alguns segundos.";
                       cepErrorEl.style.display='block';
                   }
                   return;
               }

              if (!collRef) { /* ... erro DB ... */ return; }

              // Pega valores dos campos
              const streetInput = document.getElementById('delivery-street');
              const numberInput = document.getElementById('delivery-number');
              const neighborhoodInput = document.getElementById('delivery-neighborhood');
              const cityInput = document.getElementById('delivery-city');
              const ufInput = document.getElementById('delivery-uf');
              const sizeInput = document.querySelector('input[name="size"]:checked');
              const cepInput = document.getElementById('delivery-cep');

              const deliveryAddr = {
                  street: streetInput.value.trim(),
                  number: numberInput.value.trim(),
                  neighborhood: neighborhoodInput.value.trim(),
                  city: cityInput.value.trim(),
                  uf: ufInput.value.trim().toUpperCase()
              };
              const size = sizeInput ? sizeInput.value : 'Pequeno';
              const cep = cepInput.value.replace(/\D/g, '');

              // Validação
              if (!deliveryAddr.street || !deliveryAddr.number || !deliveryAddr.neighborhood || !deliveryAddr.city || !deliveryAddr.uf) {
                  if(cepErrorEl){ cepErrorEl.textContent="Todos os campos de endereço (Rua, Número, Bairro, Cidade, UF) são obrigatórios."; cepErrorEl.style.display='block';}
                  return;
              }
               if(cepErrorEl) cepErrorEl.style.display='none';

              // Monta a string
              const fullAddress = assembleAddressString(deliveryAddr);
              console.log("Endereço montado para salvar:", fullAddress);

              const newDelivery = { /* ... objeto igual ... */ };

              // Salva no Firestore
              addDoc(collRef, newDelivery)
                   .then(() => { /* ... limpar campos ... */ })
                   .catch(error => {
                       console.error("Firestore addDoc Error:", error); // Log detalhado
                       if (cepErrorEl) {
                           cepErrorEl.textContent = `Erro DB ao salvar: ${error.message}`; // Mensagem mais específica
                           cepErrorEl.style.display = 'block';
                       }
                   });
        }
        // Carregar Entregas
        function loadDeliveries() { /* ... código igual ... */ }
        // Alternar Status
        window.toggleDeliveryStatus = async (deliveryId, currentStatus) => { /* ... código igual ... */ };
        // Excluir Entrega
        window.deleteDelivery = function(deliveryId) { /* ... código igual ... */ };

        // --- Otimização e Rota ---
        window.runOptimization = async function(isInitialLoad = false) { /* ... código igual ... */ }
        async function optimizeAndRenderRoutes(allDeliveries, isInitialLoad = false, startAddrString = null) { /* ... código igual (com API V1) ... */ }

        // --- Busca CEP ---
        window.fetchAddressByCEP = async function() { /* ... código igual ... */ }
        window.fetchBaseAddressByCEP = async function() { /* ... código igual ... */ }
        window.searchCEPsByAddress = async function() { /* ... código igual (com logs) ... */ }

        // --- Funções de Helper e Renderização ---
        function getHaversineDistance(coords1, coords2) { /* ... */ }
        function basicSortDeliveries(deliveries) { /* ... */ }
        function renderRouteList(deliveries, isBasicSort, failedDeliveries) { /* ... */ }
        function renderManagementList(allDeliveries) { /* ... */ }
        function renderOptimizedList(listElement, deliveries) { /* ... */ }
        function renderBasicGroup(listElement, groupedDeliveries, context) { /* ... */ }
        function renderFailedList(listElement, failedDeliveries) { /* ... */ }
        function renderGenericDeliveryItem(parentElement, delivery, context, streetNameIfBasic = null) { /* ... */ }
        function handleConfirmDelete(buttonElement, deliveryId) { /* ... */ }
        window.openGoogleMaps = function() { /* ... */ }
        window.printList = (context) => { /* ... */ };

    </script>
</body>
</html>
